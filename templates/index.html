<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQQ Astro Data Enrichment</title>
    <style>
        body { font-family: sans-serif; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .hidden { display: none; }
        #enrichButton, #filterButton { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>QQQ Astro Data Enrichment</h1>
        
        <!-- Step 1: Fetch Data -->
        <h2>Step 1: Fetch Data from Polygon.io</h2>
        <form id="fetchForm">
            <label for="ticker">Ticker:</label>
            <input type="text" id="ticker" name="ticker" value="QQQ" required>
            <label for="from_date">From Date:</label>
            <input type="date" id="from_date" name="from_date" required>
            <label for="to_date">To Date:</label>
            <input type="date" id="to_date" name="to_date" required>
            <label for="interval">Interval (minutes):</label>
            <select id="interval" name="interval">
                <option value="5">5</option>
                <option value="15">15</option>
            </select>
            <button type="submit">Fetch</button>
        </form>
        
        <div id="filterSection" class="hidden">
            <h3>Filter Fetched Data</h3>
            <form id="filterForm">
                <label for="diff_percentage">Difference between H & L >= (%):</label>
                <input type="number" id="diff_percentage" name="diff_percentage" value="1" step="0.1" required>
                <button type="submit">Filter</button>
            </form>
        </div>

        <div id="fetchedData" class="hidden">
            <h3>Fetched Data</h3>
            <div id="fetchedDataTable"></div>
        </div>
        
        <!-- Step 2: Enrich Data -->
        <button id="enrichButton" class="hidden">Enrich Data</button>
        <div id="enrichedData" class="hidden">
            <h3>Enriched Data</h3>
            <div id="enrichedDataTable"></div>
            <a href="/export_to_excel" id="exportButton" class="hidden" download>
                <button>Export to Excel</button>
            </a>
        </div>
    </div>

    <script>
        document.getElementById('fetchForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/fetch_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('fetchedData').classList.remove('hidden');
                    document.getElementById('fetchedDataTable').innerHTML = data.data;
                    document.getElementById('enrichButton').classList.remove('hidden');
                    document.getElementById('filterSection').classList.remove('hidden');
                }
            });
        });

        document.getElementById('filterForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('/filter_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('fetchedDataTable').innerHTML = data.data;
                }
            });
        });

        document.getElementById('enrichButton').addEventListener('click', function() {
            fetch('/enrich_data', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('enrichedData').classList.remove('hidden');
                    document.getElementById('enrichedDataTable').innerHTML = data.data;
                    document.getElementById('exportButton').classList.remove('hidden');
                }
            });
        });
    </script>
</body>
</html>
